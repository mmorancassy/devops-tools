version: "2.1"

services:
  jenkinscicd:
    image: onesaitplatform/jenkins:${JENKINS_VERSION}
    container_name: jenkinscicd
    environment:
      - RESTORE_DEFAULTS=false
      - RESTORE_MAVEN_SETTINGS=false
    volumes:
      - ${JENKINS_DATA}:/var/jenkins_home:rw
      - ${PLATFORM_CONFIG}:/tmp/op:rw  
      - ${DOCKER_DATA}:/var/run/docker.sock
    restart: on-failure     
  gitlab:
    image: gitlab/gitlab-ce:${GITLAB_VERSION}
    container_name: gitlab
    hostname: 'localhost'
    volumes:
      - ${GITLAB_CONFIG}:/etc/gitlab
      - ${GITLAB_LOGS}:/var/log/gitlab
      - ${GITLAB_DATA}:/var/opt/gitlab
      - ${GITLAB_CERTS}:/etc/gitlab/ssl      
    restart: on-failure    
  nexus:
    image: sonatype/nexus3:${NEXUS_VERSION}
    container_name: nexus
    volumes:
      - ${NEXUS_DATA}:/nexus-data     
    restart: on-failure            
  sonarqube:
    image: sonarqube:${SONAR_VERSION}
    container_name: sonarqube
    environment:
      - SONARQUBE_JDBC_URL=jdbc:postgresql://db:5432/sonar
    volumes:
      - ${SONAR_CONF}:/opt/sonarqube/conf
      - ${SONAR_DATA}:/opt/sonarqube/data
      - ${SONAR_EXT}:/opt/sonarqube/extensions
      - ${SONAR_PLUGINS}:/opt/sonarqube/lib/bundled-plugins
    restart: on-failure   
  db:
    image: postgres:${POSTGRESQL_VERSION}
    container_name: db
    networks:
      - sonarnet    
    networks:
      - sonarnet
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
    volumes:
      - ${SONAR_POSTGRESQL}:/var/lib/postgresql
      - ${SONAR_POSTGRESQL_DATA}:/var/lib/postgresql/data  
    restart: on-failure 
  reverseproxy:
    image: nginx:${NGINX_VERSION}
    container_name: reverseproxy
    ports:
      - "443:443"      
    volumes:  
      - ${NGINX_CONF}:/etc/nginx/nginx.conf:rw
      - ${NGINX_CERTS}:/etc/nginx/ssl:ro
    restart: on-failure     
  portainer:
    image: portainer/portainer
    command: -H unix:///var/run/docker.sock
    restart: always
    ports:
      - "9000:9000"
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    restart: on-failure      
volumes:
  portainer_data:    
